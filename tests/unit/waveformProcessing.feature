Feature: 波形同期加算処理
  # description
  キータップの波形データから同期加算平均を計算し、
  ノイズを低減した平均波形を生成する

  Scenario: ピーク位置を検出する
    Given: 波形データ [0.1, -0.5, 0.3, -0.8, 0.2] がある
    When: ピーク位置を検索する
    Then: インデックス 3 が返される（-0.8が最大絶対値）

  Scenario: 指定範囲内のピークを検出する
    Given: 波形データ [0.1, -0.9, 0.3, -0.8, 0.2] がある
    When: インデックス2から3サンプルの範囲でピークを検索する
    Then: インデックス 3 が返される

  Scenario: 全てゼロの場合は開始位置を返す
    Given: 波形データ [0, 0, 0, 0] がある
    When: ピーク位置を検索する
    Then: インデックス 0 が返される

  Scenario: 単一要素配列を処理する
    Given: 波形データ [0.5] がある
    When: ピーク位置を検索する
    Then: インデックス 0 が返される

  Scenario: ウィンドウ終端タイムスタンプを計算する
    Given: キーダウンタイムスタンプが [100, 200, 300] である
    And: キーアップタイムスタンプが [150, 250, 350] である
    When: ウィンドウ終端を計算する
    Then: 終端タイムスタンプは [150, 250, 350] である

  Scenario: キーアップより先の次のキーダウンを使用する
    Given: キーダウンタイムスタンプが [100, 150, 300] である
    And: キーアップタイムスタンプが [200, 400] である
    When: ウィンドウ終端を計算する
    Then: 終端タイムスタンプは [150, 200, 400] である

  Scenario: 最後のタイムスタンプにフォールバック値を使用する
    Given: キーダウンタイムスタンプが [100, 200] である
    And: キーアップタイムスタンプが [150] である
    When: ウィンドウ終端を計算する
    Then: 1番目の終端は 150 である
    And: 2番目の終端は 300 である（200 + 100msフォールバック）

  Scenario: 空の代替タイムスタンプを処理する
    Given: キーダウンタイムスタンプが [100, 200, 300] である
    And: キーアップタイムスタンプが空である
    When: ウィンドウ終端を計算する
    Then: 終端タイムスタンプは [200, 300, 400] である

  Scenario: 不十分なタイムスタンプを処理する
    Given: 1000サンプルの音声データがある
    And: タイムスタンプが [100] のみである
    And: 終端タイムスタンプが [200] である
    And: サンプルレートが 1000 である
    When: 同期加算平均を計算する
    Then: 結果が定義されている
    And: ウィンドウ数が 0以上 である

  Scenario: ピーク同期なしで平均波形を計算する
    Given: 1000Hzのサンプルレートで200サンプルの音声データがある
    And: タイムスタンプが [10, 60, 110] である（3ウィンドウ）
    And: 終端タイムスタンプが [40, 90, 140] である（各30ms）
    And: オフセットが 0ms である
    And: ピーク同期が無効である
    When: 同期加算平均を計算する
    Then: 波形が生成される
    And: ウィンドウ数は 3 である
    And: 個別ウィンドウが 3個 である

  Scenario: 複数のタイムスタンプを処理する
    Given: 1000Hzのサンプルレートで500サンプルの音声データがある
    And: タイムスタンプが [10, 60, 110, 160, 210] である（5個）
    And: 対応する終端タイムスタンプがある
    When: 同期加算平均を計算する
    Then: ウィンドウ数が 0より大きい
    And: 個別ウィンドウが存在する

  Scenario: オフセットを正しく適用する
    Given: 1000Hzのサンプルレートで200サンプルの音声データがある
    And: タイムスタンプが [50, 100, 150] である
    And: 終端タイムスタンプが [80, 130, 180] である
    And: オフセットが 10ms である
    When: 同期加算平均を計算する
    Then: 波形が生成される
    And: 最初のウィンドウのタイムスタンプは 50 である

  Scenario: ピーク同期モードでピークを揃える
    Given: 1000Hzのサンプルレートで300サンプルの音声データがある
    And: インデックス 55, 110, 165 にピークがある
    And: タイムスタンプが [50, 100, 150] である
    And: 終端タイムスタンプが [80, 130, 180] である
    And: ピーク同期が有効である
    And: ピーク位置が 5ms である
    When: 同期加算平均を計算する
    Then: 波形が生成される
    And: ウィンドウ数は 3 である

  Scenario: 異なる長さのウィンドウを処理する
    Given: 1000Hzのサンプルレートで500サンプルの音声データがある
    And: タイムスタンプが [50, 100, 200] である
    And: 終端タイムスタンプが [80, 150, 250] である（長さ: 30ms, 50ms, 50ms）
    When: 同期加算平均を計算する
    Then: 波形が生成される
    And: 出力波形の長さが 0より大きい
